<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<script>
var map = {scale:2 };
    var img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function (e) {

        console.time( "up" )
        rescaleImage(e.target, 128, 128 / 256 );
        console.timeEnd( "up" )

    };
    img.src = "http://api.tiles.mapbox.com/v4/mapbox.streets/1/0/0.png?access_token=pk.eyJ1IjoiZ3V0ZW55ZSIsImEiOiJmNjJlMDNmYTUyMzNjMzQxZmY4Mzc1ZmFiYmExNjMxOSJ9.xgl1PBwQV9CtwW-usedrcQ";
//    document.body.appendChild(img);


//        function drawPixelated(img,context,zoom,x,y)
//        {
//
////            var ctx = document.createElement('canvas').getContext('2d');
////            ctx.width  = img.width;
////            ctx.height = img.height;
//            ctx.drawImage(img,0,0);
//            var idata = ctx.getImageData(0,0,img.width,img.height).data;
//
//            for (var x2=0;x2<img.width;++x2)
//            {
//                for (var y2=0;y2<img.height;++y2)
//                {
//                    var i=(y2*img.width+x2)*4;
//                    var r=idata[i  ];
//                    var g=idata[i+1];
//                    var b=idata[i+2];
//                    var a=idata[i+3];
//                    context.fillStyle = "rgba("+r+","+g+","+b+","+(a/255)+")";
//                    context.fillRect(x+x2*zoom, y+y2*zoom, zoom, zoom);
//                }
//            }
//        };
//        drawPixelated.idataById={};
//        drawPixelated.lastImageId=0;
//    rescales the image so that it fits the map's scale


    function rescaleImage( img, tileSize, scale )
    {

        var canvas = document.createElement( 'canvas' );
        document.body.appendChild(canvas);
        var w = canvas.width  = img.width ;
        var h = canvas.height = img.height;
        
        //collect image data
        var ctx = canvas.getContext("2d");
        ctx.drawImage( img, 0,0,w,h );
        var srcData = ctx.getImageData( 0,0,w,h).data;

        //result
        var imgOut = ctx.createImageData(tileSize,tileSize);
        var out = imgOut.data;

        //nearest neighbours upscale
        for( var i = 0; i < srcData.length; i+=4 )
        {
            var x = ( i/4 % w ) * scale;
            var y = ~~( i/4 / w ) * scale;
            for( var j = x; j <= x + scale; j++ )
            {
                for( var k = y; k <= y + scale; k++ ) {

                    var id = ( ~~( j ) + ~~( k ) * tileSize ) * 4;
                    out[id]     = srcData[i  ];
                    out[id + 1] = srcData[i+1];
                    out[id + 2] = srcData[i+2];
                    out[id + 3] = srcData[i+3];
                }
            }
        }
        canvas.width  = canvas.height = tileSize;
        imgOut.data = out;
        ctx.putImageData(imgOut,0,0);

        /*

        imgData.data = new Uint8ClampedArray( w * h * 4 );

        console.log( srcData.data.length,imgData.data.length );
        
        var scale = map.scale;
        for( var i = 0; i < imgData.data.length; i+=4 )
        {
            var id = ~~( ( i / scale ) );
            if( i < 36 )console.log( i, id );
            imgData.data[ id ]   = srcData[ id ];// ~~( Math.random() * 0x80 );
            imgData.data[ id+1 ] = srcData[ id+1 ];// ~~( Math.random() * 0x80 );
            imgData.data[ id+2 ] = srcData[ id+2 ];// ~~( Math.random() * 0x80 );
            imgData.data[ id+3 ] = 0xFF;
        }
        console.log( srcData, "->", imgData );
        
        w = canvas.width  = 512;
        h = canvas.height = 512;
        ctx.fillRect(0,0,w,h);
//        var imgData = ctx.getImageData( 0,0,w,h);
//        imgData.data.set( dstData );
        ctx.putImageData(imgData, 0,0 );
        //*/
        //replace img with canvas
    //    delete img;
    //    img = canvas;
    
    }
</script>
</body>
</html>