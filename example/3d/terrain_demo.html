<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>3D light-map</title>
    <style>
        head, body{
            width:100%;
            height:100%;
            overflow: hidden;
            top:0;
            left:0;
            margin:0;
            padding:0;
        }
    </style>
</head>


<body>
<!--http://www.opengeospatial.org/blog/2034-->
<!--preeecious -->
<!--http://gptogc.esri.com/geoportal/rest/find/document?searchText=WMS&start=1&max=10&f=searchpage-->

<!--http://gptogc.esri.com/geoportal/catalog/search/resource/livedata-preview.page?uuid=%7BB95DD1FA-0CC3-4B83-952C-CE7DE826B355%7D&url=http%3A%2F%2Fmaps.ngdc.noaa.gov%2Farcgis%2Fservices%2Fetopo1%2FMapServer%2FWMSServer%3Frequest%3DGetCapabilities%26service%3DWMS&resourceType=wms&info=%2Fgeoportal%2Frest%2Fdocument%3Ff%3Dhtml%26showRelativeUrl%3Dtrue%26id%3D%257BB95DD1FA-0CC3-4B83-952C-CE7DE826B355%257D-->

    <!--http://celestia.h-schmidt.net/earth-vt/-->
    <!--ftp://ftp.cscs.ch/out/stockli/bluemarble/Blue_Marble_2002/-->
    <!--http://spatialhorizons.com/2007/08/13/map-tiles-4-xna-program/-->

<!--
http://www.imagico.de/map/demsearch.php

http://www.imagico.de/map/dem_json.php?date=&lon= 6.64585499999998&lat=44.61891184901208&lonE=10.864604999999965&latE=47.54417619111972&vf=1


//FLIPPED TOP BOTTOM !

//            http://www.imagico.de/map/dem_json.php?date=&lon=-180.0&lat=-90.0&lonE=180.0&latE=90.0&vf=1

// &srtm=0
// &glcf1=0
// &glcf2=0
// &glcf3=0
// &glcf4=0
// &gls=0
// &cgiar=0
// &vf=1
// &aster=0
// &ca=0
// &ca2=0
// &ned1=0
// &ned3=0
// &ned2=0
// &srtm1=0
// &srtm1o=0

http://www.viewfinderpanoramas.org/dem3.html


ArcGIS


-->

    <script src="../light-map.min.js" type="application/javascript"></script>
    <script src="vendor/three.min.js" type="application/javascript"></script>
    <script src="vendor/controls/OrbitControls.js" type="application/javascript"></script>
    <script src="stage3d.js" type="application/javascript"></script>
    <script src="glsl/ShaderLoader.js" type="application/javascript"></script>

    <script>

        var diffuse_map, heightmap_map;
        var diffuse_provider = "http://ttiles{s}.mqcdn.com/tiles/1.0.0/vy/sat/{z}/{x}/{y}.png", diffuse_domains = "01,02,03,04".split(',');
        var heighmap_provider = "../proxy.php?url=" +"http://a{s}.acetate.geoiq.com/tiles/terrain/{z}/{x}/{y}.png", heightmap_domains = "1,2,3,4".split(',');

        //http://maps.ngdc.noaa.gov/arcgis/rest/services/web_mercator

        var repo = "etopo1_hillshade";
        repo = "etopo1";
//        repo = "emag2";
        heighmap_provider = "http://maps.ngdc.noaa.gov/arcgis/rest/services/web_mercator/"+repo+"/MapServer/tile/{z}/{y}/{x}";
//        http://maps.ngdc.noaa.gov/arcgis/rest/services/etopo1/MapServer/tile/3/0/0
        heightmap_domains = [''];
//        http://a0.acetate.geoiq.com/tiles/hillshading/6/32/24.png
        var texture_size = 512;

        function createMaps()
        {
            var lat = 46.10094;
            var lon = 8.75523;
            var zoom = 7;
            diffuse_map = new Map( diffuse_provider, diffuse_domains, texture_size, texture_size, 0,18 );
            diffuse_map.setView(lat,lon,zoom);
//            document.body.appendChild( diffuse_map.canvas );
//            diffuse_map.canvas.style.position = "absolute";
//            diffuse_map.canvas.style.top = 0;
//            diffuse_map.canvas.style.left = 0;


            heightmap_map = new Map( heighmap_provider, heightmap_domains, texture_size, texture_size, 0,18 );
//            heightmap_map.setView(lat,lon,zoom );
//            document.body.appendChild( heightmap_map.canvas );
//            heightmap_map.canvas.style.position = "absolute";
//            heightmap_map.canvas.style.top = 0;
//            heightmap_map.canvas.style.left = texture_size + 10 + "px";

//            console.log( heightmap_map.getViewPortBounds() );

//            var coords = {left: 6.64585499999998, top: 47.54417619111972, right: 10.864604999999965, bottom: 44.61891184901208}
//            http://terrain.party/api/export?box=6.64585499999998%2C47.54417619111972%2C10.864604999999965%2C44.61891184901208&name=paris


        }

        function createLights()
        {
            var l0 = new THREE.PointLight(0xFFFFFF, 1);
            l0.position.set( 0,200,0 );
            stage3d.add( l0 );
        }

        function createTerrain()
        {

            var diffuse = new THREE.Texture( diffuse_map.canvas );
            diffuse_map.eventEmitter.on( Map.ON_LOAD_COMPLETE, function()
            {
                diffuse_map.renderTiles();
                heightmap_map.renderTiles();
                diffuse.needsUpdate = true;
                heightmap.needsUpdate = true;
            });
            diffuse_map.eventEmitter.on( Map.ON_TEXTURE_UPDATE, function()
            {
                diffuse.needsUpdate = true;
            });

            var heightmap = THREE.ImageUtils.loadTexture( "heightmap.png" );// heightmap_map.canvas);
//            heightmap_map.eventEmitter.on( Map.ON_TEXTURE_UPDATE, function( ctx )
//            {
//                ctx.lineWidth = 4;
//                ctx.strokeRect( 1,1,heightmap_map.width-2, heightmap_map.height-2 );
//                heightmap.needsUpdate = true;
//            });
//
//            heightmap_map.eventEmitter.on( Map.ON_LOAD_COMPLETE, function(){
//                diffuse_map.renderTiles();
//                heightmap_map.renderTiles();
//                diffuse.needsUpdate = true;
//                heightmap.needsUpdate = true;
//            });

            var RAD = Math.PI / 180;
            var angle = 60;
            stage3d.controls.minPolarAngle = angle * RAD;
            stage3d.controls.maxPolarAngle = angle * RAD;


            var size = 512;
            /*
            var bufferVertices = new Float32Array( size * size * 3 );
            var bufferIndices = new Float32Array( size * size * 2 );
            var bufferUVS = new Float32Array( size * size * 2 );
            for( var i = 0; i < size * size; i++ )
            {

                var x = ( i % size );
                var y = ~~( i / size );
                bufferVertices[ i * 3  ] = ( x-size/2 ) * ( 256 / size );
                bufferVertices[ i * 3 + 1 ] = ( y-size/2 ) * ( 256 / size );
                bufferVertices[ i * 3 + 2 ] = 0;

                bufferUVS[ i * 2 ] = x / size;
                bufferUVS[ i * 2 + 1 ] = y / size;

            }
            var geom = new THREE.BufferGeometry();
            geom.addAttribute( "position", new THREE.BufferAttribute( bufferVertices, 3 ) );
            geom.addAttribute( "uv", new THREE.BufferAttribute( bufferUVS, 2 ) );
            //*/

            var material = new THREE.ShaderMaterial({
                uniforms : {
                    diffuse : { type: "t", value : diffuse },
                    heightmap : { type: "t", value : heightmap },
                    elevation : { type: "f", value : 25 },
                    pointSize : { type: "f", value : 2 }
                },
                attributes:{},
                vertexShader : ShaderLoader.shaders.vertex,
                fragmentShader : ShaderLoader.shaders.fragment,
                side:THREE.DoubleSide
            });

//            var m = new THREE.PointCloud( geom, material );
            var geom = new THREE.PlaneGeometry( 256, 256, 512,512 );
            var m = new THREE.Mesh( geom, material );
            m.rotateX( -Math.PI / 2 );
            m.rotateZ( Math.PI / 4 );
            stage3d.add( m );
            return m;
        }

        window.onload = function()
        {
//            return ;
            var sl = new ShaderLoader();
            var shaders = { vertex:"", fragment:"" };

            sl.loadShaders(shaders, "./glsl/", function() {

                init();
                animate();

            });
        };
        function init()
        {
            stage3d.init( window.innerWidth,window.innerHeight );
            createMaps();
            createLights();
            createTerrain();
        }
        function animate()
        {
            requestAnimationFrame(animate);
            stage3d.render();
        }
    </script>

    <script>



        var urls = "worldbank-projects-sa, acetate-labels, worldbank-projects-eap, worldbank-sudan, hillshading, terrain, acetate-roads, blue-world-4326, worldbank-projects-eca, blank, black-world, acetate-base-4326, worldbank-projects-afr, blue-world, worldbank-labels, black-plain, worldbank-projects-lac, worldbank-foreground, graticule, acetate-hillshading, acetate, worldbank, acetate-base, acetate-fg, acetate-blank, worldbank-projects-mena, worldbank-hillshading, acetate-bg, worldbank-projects ]".split(", ");

        urls.forEach(function(u)
        {
            return;


            var img = new Image();
            document.body.appendChild(img);
            img.src = "../proxy.php?url=" + "http://a2.acetate.geoiq.com/tiles/"+u+"/8/267/181.png";
            console.log( u );
        });




//        var bbox = "447031.55809854745%2C5641466.125624101%2C483988.8612743803%2C5674334.047786682";
//        "-3977748.7402200894%2C1372145.7683518566%2C5483320.8728033705%2C9786333.84198182"
//        img.src="http://elevation.arcgis.com/arcgis/rest/services/WorldElevation/Terrain/ImageServer/exportImage?f=image&format=jpgpng&compressionQuality=75&bandIds=&bbox="+bbox+"&imageSR=102100&bboxSR=102100&size=512%2C512&token=qp5we_Gbb9JFh-t0vipELTQgCX0FMQQUwZApX2IVCI597snkhEy0hFTR3slB1w3iBJ9dfAR__837LKzsrNiGCPbo4vgWvfcFDewChRidecUHxFmd_fD9ppQfHDyKBNYoSSLADYJ_9lKo8InwiqtMItu7zWe6QHl7YfVfMNtFRzDrVJuNTNz1_a9hEexI07is45cMlgl7l7mLmZCp8oOGwm0UrVDaXZP_CdmMOIEqTfTxix9AutonKBZhOAiXOQdj";

//        http://elevation.arcgis.com/arcgis/rest/services/WorldElevation/Terrain/ImageServer/exportImage?f=image&format=jpgpng&compressionQuality=75&bandIds=&bbox=-3977748.7402200894%2C1372145.7683518566%2C5483320.8728033705%2C9786333.84198182&imageSR=102100&bboxSR=102100&size=967%2C860&token=qp5we_Gbb9JFh-t0vipELTQgCX0FMQQUwZApX2IVCI597snkhEy0hFTR3slB1w3iBJ9dfAR__837LKzsrNiGCPbo4vgWvfcFDewChRidecUHxFmd_fD9ppQfHDyKBNYoSSLADYJ_9lKo8InwiqtMItu7zWe6QHl7YfVfMNtFRzDrVJuNTNz1_a9hEexI07is45cMlgl7l7mLmZCp8oOGwm0UrVDaXZP_CdmMOIEqTfTxix9AutonKBZhOAiXOQdj

    </script>

</body>
</html>